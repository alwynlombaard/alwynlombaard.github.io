<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Handling push notifications in Flutter with Firebase | Alwyn Lombaard’s blog</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Handling push notifications in Flutter with Firebase" />
<meta name="author" content="Alwyn Lombaard" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Handling push notifications is not a straightforward task, unfortunately. So if you want to handle push notifications in iOS and Android there are a few factors to consider in Flutter, namely: Is the app in the foreground or background? If in the background, is the app in a running or terminated state? These scenarios require specific handling in Flutter depending on the platform." />
<meta property="og:description" content="Handling push notifications is not a straightforward task, unfortunately. So if you want to handle push notifications in iOS and Android there are a few factors to consider in Flutter, namely: Is the app in the foreground or background? If in the background, is the app in a running or terminated state? These scenarios require specific handling in Flutter depending on the platform." />
<link rel="canonical" href="http://localhost:4000/flutter/2021/12/08/handling-push-notifications-in-fluter-with-firebase.html" />
<meta property="og:url" content="http://localhost:4000/flutter/2021/12/08/handling-push-notifications-in-fluter-with-firebase.html" />
<meta property="og:site_name" content="Alwyn Lombaard’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-08T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Handling push notifications in Flutter with Firebase" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alwyn Lombaard"},"dateModified":"2021-12-08T00:00:00+00:00","datePublished":"2021-12-08T00:00:00+00:00","description":"Handling push notifications is not a straightforward task, unfortunately. So if you want to handle push notifications in iOS and Android there are a few factors to consider in Flutter, namely: Is the app in the foreground or background? If in the background, is the app in a running or terminated state? These scenarios require specific handling in Flutter depending on the platform.","headline":"Handling push notifications in Flutter with Firebase","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/flutter/2021/12/08/handling-push-notifications-in-fluter-with-firebase.html"},"url":"http://localhost:4000/flutter/2021/12/08/handling-push-notifications-in-fluter-with-firebase.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/favicon.png"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Alwyn Lombaard&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Alwyn Lombaard&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/playlist/">Playlist</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Handling push notifications in Flutter with Firebase</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-12-08T00:00:00+00:00" itemprop="datePublished">Dec 8, 2021
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Alwyn Lombaard</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Handling push notifications is not a straightforward task, unfortunately. So if you want to handle push notifications in iOS and Android there are a few factors to consider in <code class="language-plaintext highlighter-rouge">Flutter</code>, namely:</p>

<ul>
  <li>Is the app in the foreground or background?</li>
  <li>If in the background, is the app in a running or terminated state?</li>
</ul>

<p>These scenarios require specific handling in Flutter depending on the platform.</p>

<!--more-->

<h2 id="background">Background</h2>

<p>You can find a guide to set up push notifications in the Flutter documentation:</p>

<p>Overview:</p>

<p><a href="https://firebase.flutter.dev/docs/overview">Installation and Initialization or FlutterFire</a></p>

<p><a href="https://firebase.flutter.dev/docs/messaging/usage">How to use Cloud Messaging in Flutter</a></p>

<h2 id="my-solution-to-setting-up-push-notification-handling">My solution to setting up push notification handling</h2>

<p>Below is a <code class="language-plaintext highlighter-rouge">Dart</code> code extract that sums up how I approached the setting up and handling of push notifications in <code class="language-plaintext highlighter-rouge">Flutter</code> for both iOS and Android appications in the following states:</p>

<ul>
  <li>Foreground</li>
  <li>Background (app still running)</li>
  <li>Terminated (app not running)</li>
</ul>

<p>The requirement is that in all of these states a push notification message should be handled in the same way.</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">setupPushNotifications</span><span class="o">()</span> <span class="n">async</span> <span class="o">{</span>
    <span class="n">await</span> <span class="n">FirebaseMessaging</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">subscribeToTopic</span><span class="o">(</span><span class="s">'general'</span><span class="o">);</span>

    <span class="c1">//handle background messages while app is running</span>
    <span class="n">FirebaseMessaging</span><span class="o">.</span><span class="na">onMessageOpenedApp</span><span class="o">.</span><span class="na">listen</span><span class="o">(</span><span class="n">_handlePushNotificationMessage</span><span class="o">);</span>

    <span class="c1">//handle messages that caused the app to launch</span>
    <span class="n">RemoteMessage</span><span class="o">?</span> <span class="n">initialMessage</span> <span class="o">=</span>
        <span class="n">await</span> <span class="n">FirebaseMessaging</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">getInitialMessage</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">initialMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">_handlePushNotificationMessage</span><span class="o">(</span><span class="n">initialMessage</span><span class="o">,</span>
          <span class="nl">isFromTerminatedState:</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//foreground messages ios</span>
    <span class="n">await</span> <span class="n">FirebaseMessaging</span><span class="o">.</span><span class="na">instance</span>
        <span class="o">.</span><span class="na">setForegroundNotificationPresentationOptions</span><span class="o">(</span>
      <span class="nl">alert:</span> <span class="kc">true</span><span class="o">,</span>
      <span class="nl">badge:</span> <span class="kc">true</span><span class="o">,</span>
      <span class="nl">sound:</span> <span class="kc">true</span><span class="o">,</span>
    <span class="o">);</span>

    <span class="c1">//foreground messages android</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">Platform</span><span class="o">.</span><span class="na">isAndroid</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">const</span> <span class="n">AndroidNotificationChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">AndroidNotificationChannel</span><span class="o">(</span>
          <span class="s">'myapp_channel'</span><span class="o">,</span> <span class="s">'myapp_ Notifications'</span><span class="o">,</span>
          <span class="nl">description:</span> <span class="s">'This channel is used for MyApp notifications.'</span><span class="o">,</span>
          <span class="nl">importance:</span> <span class="n">Importance</span><span class="o">.</span><span class="na">max</span><span class="o">);</span>

      <span class="kd">final</span> <span class="n">FlutterLocalNotificationsPlugin</span> <span class="n">flutterLocalNotificationsPlugin</span> <span class="o">=</span>
          <span class="n">FlutterLocalNotificationsPlugin</span><span class="o">();</span>

      <span class="n">await</span> <span class="n">flutterLocalNotificationsPlugin</span>
          <span class="o">.</span><span class="na">resolvePlatformSpecificImplementation</span><span class="o">&lt;</span>
              <span class="n">AndroidFlutterLocalNotificationsPlugin</span><span class="o">&gt;()</span>
          <span class="o">?.</span><span class="na">createNotificationChannel</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>

      <span class="n">FirebaseMessaging</span><span class="o">.</span><span class="na">onMessage</span><span class="o">.</span><span class="na">listen</span><span class="o">((</span><span class="n">RemoteMessage</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RemoteNotification</span><span class="o">?</span> <span class="n">notification</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">notification</span><span class="o">;</span>
        <span class="n">AndroidNotification</span><span class="o">?</span> <span class="n">android</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">notification</span><span class="o">?.</span><span class="na">android</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">notification</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">android</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">flutterLocalNotificationsPlugin</span><span class="o">.</span><span class="na">show</span><span class="o">(</span>
              <span class="n">notification</span><span class="o">.</span><span class="na">hashCode</span><span class="o">,</span>
              <span class="n">notification</span><span class="o">.</span><span class="na">title</span><span class="o">,</span>
              <span class="n">notification</span><span class="o">.</span><span class="na">body</span><span class="o">,</span>
              <span class="n">NotificationDetails</span><span class="o">(</span>
                <span class="nl">android:</span> <span class="n">AndroidNotificationDetails</span><span class="o">(</span>
                  <span class="n">channel</span><span class="o">.</span><span class="na">id</span><span class="o">,</span>
                  <span class="n">channel</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
                  <span class="nl">channelDescription:</span> <span class="n">channel</span><span class="o">.</span><span class="na">description</span><span class="o">,</span>
                  <span class="nl">icon:</span> <span class="s">'ic_notification'</span><span class="o">,</span>
                <span class="o">),</span>
              <span class="o">));</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="o">}</span>
  <span class="o">}</span>

</code></pre></div></div>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">_handlePushNotificationMessage</span><span class="p">(</span><span class="n">RemoteMessage</span> <span class="n">message</span><span class="o">,</span>
      <span class="o">{</span><span class="n">isFromTerminatedState</span> <span class="o">=</span> <span class="kc">false</span><span class="o">})</span> <span class="n">async</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">(</span><span class="s">'FCM message handled'</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<h2 id="packages-required">Packages required</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flutter pub add firebase_core

flutter pub add firebase_messaging

flutter pub add flutter_local_notifications

</code></pre></div></div>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="s">'package:firebase_core/firebase_core.dart'</span><span class="o">;</span>

<span class="kn">import</span> <span class="s">'package:firebase_messaging/firebase_messaging.dart'</span><span class="o">;</span>

<span class="kn">import</span> <span class="s">'package:flutter_local_notifications/flutter_local_notifications.dart'</span><span class="o">;</span>
</code></pre></div></div>

<h2 id="firebase-initialization">Firebase Initialization</h2>
<p>I opted to use a <code class="language-plaintext highlighter-rouge">FutureBuilder</code> for Firebase initialization. This allows to handle error cases and also to display an activity indicator to the user while initialization is taking place.</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="o">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">FutureBuilder</span><span class="o">(</span>
      <span class="nl">future:</span> <span class="n">_initializeFirebase</span><span class="o">,</span>
      <span class="nl">builder:</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">snapshot</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">snapshot</span><span class="o">.</span><span class="na">hasError</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">log</span><span class="o">(</span><span class="s">'Could not initialise firebase'</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">_buildScaffold</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">snapshot</span><span class="o">.</span><span class="na">connectionState</span> <span class="o">==</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="na">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setupPushNotifications</span><span class="o">();</span>
          <span class="k">return</span> <span class="n">_buildScaffold</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kd">const</span> <span class="n">Center</span><span class="o">(</span>
            <span class="nl">child:</span> <span class="n">SizedBox</span><span class="o">(</span>
                <span class="nl">height:</span> <span class="mi">60</span><span class="o">,</span> <span class="nl">width:</span> <span class="mi">60</span><span class="o">,</span> <span class="nl">child:</span> <span class="n">CircularProgressIndicator</span><span class="o">()));</span>
      <span class="o">},</span>
    <span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">_initializeFirebase</span> <span class="o">=</span> <span class="n">Firebase</span><span class="o">.</span><span class="na">initializeApp</span><span class="o">();</span>
</code></pre></div></div>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Scaffold</span> <span class="nf">_buildScaffold</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Scaffold</span><span class="o">(</span>
      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="o">(</span>
        <span class="nl">title:</span> <span class="n">Text</span><span class="o">(</span><span class="n">widget</span><span class="o">.</span><span class="na">title</span><span class="o">),</span>
      <span class="o">),</span>
      <span class="nl">body:</span> <span class="n">Center</span><span class="o">(</span>
        <span class="nl">child:</span> <span class="n">Column</span><span class="o">(</span>
          <span class="nl">mainAxisAlignment:</span> <span class="n">MainAxisAlignment</span><span class="o">.</span><span class="na">center</span><span class="o">,</span>
          <span class="nl">children:</span> <span class="kd">const</span> <span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;[</span>
            <span class="n">Text</span><span class="o">(</span>
              <span class="s">'My App'</span><span class="o">,</span>
            <span class="o">),</span>
          <span class="o">],</span>
        <span class="o">),</span>
      <span class="o">),</span>
    <span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<h2 id="ensure-widgets-are-initialized">Ensure Widgets are initialized</h2>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">WidgetsFlutterBinding</span><span class="o">.</span><span class="na">ensureInitialized</span><span class="o">;</span>
  <span class="n">runApp</span><span class="o">(</span><span class="kd">const</span> <span class="n">MyApp</span><span class="o">());</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="o">{</span>
  <span class="kd">const</span> <span class="n">MyApp</span><span class="o">({</span><span class="n">Key</span><span class="o">?</span> <span class="n">key</span><span class="o">})</span> <span class="o">:</span> <span class="k">super</span><span class="o">(</span><span class="nl">key:</span> <span class="n">key</span><span class="o">);</span>

  <span class="nd">@override</span>
  <span class="n">_MyAppState</span> <span class="n">createState</span><span class="o">()</span> <span class="o">=&gt;</span> <span class="n">_MyAppState</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="request-permisson">Request permisson</h2>
<p>Request permission from the user to send push notifications. Ask for this at the appropriate time. It could be at app start, but in some cases only after successful user login.</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">requestPushNotificationPermission</span><span class="o">()</span> <span class="n">async</span> <span class="o">{</span>
    <span class="n">FirebaseMessaging</span> <span class="n">messaging</span> <span class="o">=</span> <span class="n">FirebaseMessaging</span><span class="o">.</span><span class="na">instance</span><span class="o">;</span>

    <span class="n">NotificationSettings</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">await</span> <span class="n">messaging</span><span class="o">.</span><span class="na">requestPermission</span><span class="o">(</span>
      <span class="nl">alert:</span> <span class="kc">true</span><span class="o">,</span>
      <span class="nl">announcement:</span> <span class="kc">false</span><span class="o">,</span>
      <span class="nl">badge:</span> <span class="kc">true</span><span class="o">,</span>
      <span class="nl">carPlay:</span> <span class="kc">false</span><span class="o">,</span>
      <span class="nl">criticalAlert:</span> <span class="kc">false</span><span class="o">,</span>
      <span class="nl">provisional:</span> <span class="kc">false</span><span class="o">,</span>
      <span class="nl">sound:</span> <span class="kc">true</span><span class="o">,</span>
    <span class="o">);</span>
    <span class="n">log</span><span class="o">(</span><span class="s">'User granted permission: </span><span class="si">${settings.authorizationStatus}</span><span class="s">'</span><span class="o">);</span>

    <span class="kd">var</span> <span class="n">token</span> <span class="o">=</span> <span class="n">await</span> <span class="n">messaging</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>
    <span class="n">log</span><span class="o">(</span><span class="s">'FCM Device Token: </span><span class="si">$token</span><span class="s">'</span><span class="o">);</span>
  <span class="o">}</span>

</code></pre></div></div>

<h2 id="obtaining-the-device-token">Obtaining the device token</h2>

<p>In order to trigger push notifications to individual user devices, you need to obtain and store the device token for the user in your back end data store. Here is how to obtain the token.</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Future</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">saveDeviceTokenForUser</span><span class="o">(</span><span class="kt">String</span> <span class="n">userId</span><span class="o">)</span> <span class="n">async</span> <span class="o">{</span>
    <span class="kd">var</span> <span class="n">token</span> <span class="o">=</span> <span class="n">await</span> <span class="n">FirebaseMessaging</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">getToken</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

    <span class="c1">//save token</span>
    <span class="o">...</span>
  <span class="o">}</span>
</code></pre></div></div>


  </div><ul></ul><a class="u-url" href="/flutter/2021/12/08/handling-push-notifications-in-fluter-with-firebase.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Alwyn Lombaard&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Alwyn Lombaard&#39;s blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/alwynlombaard"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">alwynlombaard</span></a></li><li><a href="https://www.twitter.com/mrlombaard"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">mrlombaard</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Mobile developer (guitar student and athlete in my spare time)</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
